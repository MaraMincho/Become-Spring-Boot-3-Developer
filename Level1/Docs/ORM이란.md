
# ORM이란(Object relational mapping)

ORM은 자바의 데이터베이스를 연결하는 프로그래밍 기법입니다. 예를 들어 데이터베이스에 age, name 칼럼에 20, 홍길동이라는 값이 들어있다고 생각해보죠. 이것을 자바에서 사용하려면 어떻게 해야 할까요? 아마 다른 방법이 필요합니다. 보통은 SQL이라는 언어로 데이터를 꺼내 사용하죠. 그러면 SQL을 새로 공부해야하니 골치가 아픕니다. 

![alt text](/Images/image.png)

하지만 ORM 이 있다면 데이버에스의 값을 마치 객체처럼 사용할 수 있습니다. 쉽게 말해 SQL을 전혀 몰라도 자바 언어로만 데이터베이스에 접근해서 원하는 데이터를 받아 올 수 있게 해주는 도구를 ORM이라고 합니다. 


# ORM의 장점과 단점

장점
- SQL을 직접 생성하지 않고 사용하는 언어로 데이터베이스에 접근 할 수 있습니다.
- 객체지향적으로 코들르 작성할 수 있기 때문에 비지니스 로직에 집중할 수 있습니다.
- 데이터베이스 시스템이 추상화되어 있기 때문에 MySQL에서 PostreSQL로 전환한다고 해도 추가로 드는 작업이 거의 없습니다. 즉, 데이터베이스 시스템에 대한 종속성이 줄어듭니다.
- 매핑하는 정보가 명확하기 때문에 ERD의 의존도를 낮출 수 있고 유지보수 할 때 유리합니다.

단점
- 프로젝트의 복잡성이 커질수록 사용 난이도도 올라갑니다.
- 복잡하고 무거운 쿼리는 ORM으로 해결 불가능한 경우가 있습니다. 

# JPA와 하이버네이트
DBMS에도 여러 종류가 있는 것 처럼 ORM에도 여러 종류가 있습니다. ORM프레임워크를 추가로 선택하야 하는데, 대표적으로 하이버네이트를 주로 선택합니다.
하이버네이트는 JPA인터페이스를 구현한 구현체이자 자바용 ORM 프레임 네트워크 입니다. 
내부적으로 JDBC API를 사용합니다. 하이버네이트의 목표는 자바 객체를 통해 데이터베이스 종류에 상관 없이 데이터베이스를 자유자제로 사용할 수 있게 하는 데 있습니다. 

![alt text](/Images/image2.png)


#  엔티티 매니저란
JPA와 하이버네이트에 대해서 알아보았으니, JPA의 중요한 컨셉중 하나인 엔티티 매니저와 영속성 컨텍스트를 알아보겠습니다. 

# 엔티티
엔티티는 데이터베이스의 테이블과 매핑되는 객체를 의미합니다. 엔티티는 본질적으로 자바 객체이므로 일반 객체와 다르지 않습니다. 하지만 데이터베이스의 테이블과 직접 연결된다는 아주 특별한 특징이 있어 구분지어 부릅니다. 즉 엔티팉는 객체이긴 하지만 데이터베이스의 영향을 미치는 쿼리를 실행하는 객체인 것이죠.

# 엔티티 매니저
엔티티 매니저는 엔티티를 관리해 데이터베이스와 애플리케이션 사이에서 객체를 생성, 수정 삭제 하는 등의 역할을 합니다. 그리고 엔티티 매니저를 만드는 곳이 엔티티 매니저 팩토리 입니다. 

![alt text](/Images/image3.png)

# 영속성 컨텍스트
엔티티 매니저는 엔티티를 영속성 컨텍스트에 저장한다는 특징이 있습니다. 영속성 컨텍스는 JPA의 중요한 특징중 하나로, 엔티티를 관리하는 가상의 공간입니다. 이것이 있기 때문에 데이터베이스에서 효과적으로 데이터를 가져올 수있고, 엔티티를 편하게 사용할 수 있는 것이죠.


영속성 컨텍스트에서는 1차 캐시, 쓰기 지연, 변경 감지, 지연 로딩 이라는 특징이 있습니다.

1차 캐시
- 1차 캐시에서 키는 @Id 애너테이션이 달린 기본키 역할을 하는 식별자이며 값은 앤티티 입니다. 
- 값이 없으면 ㄷ이터베이스에서 조회해 1차 캐이셍서 저장한다음 반환합니다. 
- 이를 통해 캐시된 데이터를 조회할 때에는 데이터베이스를 거치지 않아도 되므로 빠르게 데이터를 조회할 수 있습니다. 


쓰기 지연
- 트랜잭션을 커밋하기 전까지는 데이터베이스에 실제로 질의문을 보내지 않고 쿼리를 모았다가 트랜잭션을 커밋하면 모았던 쿼리를 한번에 실행하는 것
- 예를 들어 커밋 시점 쿼리 3개를 한번에 전송하는 것을 말함
- 이를 통해 DB 부담을 낮출 수 있므

변경 감지
- 트랜잭션을 커밋하면 1차캐시에 저장되어있는 엔티티의 값과 현재 엔티티의 값을 비교해 변경된 값이 있다면 변경사항을 감지해 변경된 값을 데이터베이스에 자동으로 반영합니다.


지연 로딩
- 쿼리로 요청한 데이터를 바로 요청이 아닌, 필요할 때 쿼리를 요청


위 특징들은 데이터베이스의 접근을 최소화 하여 성능을 높일 수 있습니다. 



# 엔티티의 상태

엔티티는 4가지 상태를 가집니다. 영속성 컨텍스트가 관리하고 있지 않는 분리 상태, 영속성 컨텍스가 관리하는 관리 상태, 연속성 컨텍스트와 전혀 관계가 없는 비영속 상태, 삭제된 상태 로 나뉩니다.

```java
public class EntityManagerTest {

@Autowired
EntityManager em;

public void example() {
    // 1 엔티티 매니저가 엔티티를 관리하지 않는 상태(비영속 상태)
    Member member = new Member(1L, "홍길동");
    // 2 엔티티가 관리되는 상태
    em.persist(member);
    // 3 엔티티 객체가 분리된 상태
    em.detach(member);
    // 4 엔티티 객체가 삭제된 상태
    em.remove(member);
}
}
```

